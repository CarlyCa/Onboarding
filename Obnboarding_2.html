<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newcomer Assistant</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: url('background.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
        }
        .message-container {
            margin-bottom: 20px;
            overflow-y: auto;
            max-height: 500px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .message {
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            word-wrap: break-word;
            max-width: 70%;
            position: relative;
        }
        .message.bot {
            background-color: #7b32a8;
            color: #fff;
        }
        .message.user {
            background-color: #33a8a0;
            color: #fff;
            margin-left: auto;
            margin-right: 0;
            text-align: right;
        }
        .avatar {
            width: 30px;
            height: 30px;
            background-image: url('https://upload.wikimedia.org/wikipedia/en/thumb/c/c4/Charlotte_Hornets_%282014%29.svg/440px-Charlotte_Hornets_%282014%29.svg.png');
            background-size: cover;
            background-repeat: no-repeat;
            border-radius: 50%;
            position: absolute;
            bottom: -15px;
            left: -40px;
        }
        .avatar:before {
            content: '';
            width: 8px;
            height: 8px;
            background-color: #fff;
            border-radius: 50%;
            position: absolute;
            bottom: -2px;
            left: -2px;
        }
        .message.user .avatar {
            left: auto;
            right: -40px;
        }
        .message.user .avatar:before {
            left: auto;
            right: -2px;
        }
        input[type="text"], input[type="button"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        input[type="button"] {
            background-color: #7b32a8;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        input[type="button"]:hover {
            background-color: #33a8a0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Newcomer Assistant</h1>
        <div class="message-container" id="messageContainer"></div>
        <input type="text" id="userInput" placeholder="Type your message...">
        <input type="button" value="Send Message" onclick="sendMessage()">
        <input type="button" value="I'm Ready to Find My Neighborhood Match" onclick="sendConversationLog()">
    </div>

    <script>
        window.onload = function() {
            document.getElementById("userInput").value = "";
        };

        async function query(data, url, token) {
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                method: "POST",
                body: JSON.stringify(data),
            });
            const result = await response.json();
            return result;
        }

        const messageContainer = document.getElementById("messageContainer");
        const userInput = document.getElementById("userInput");

        function appendMessage(message, sender) {
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message");
            messageDiv.innerHTML = message;
            if (sender === "bot") {
                messageDiv.classList.add("bot");
                const avatarDiv = document.createElement("div");
                avatarDiv.classList.add("avatar");
                messageDiv.appendChild(avatarDiv);
            } else if (sender === "user") {
                messageDiv.classList.add("user");
            }
            messageContainer.appendChild(messageDiv);
            // Scroll to the bottom of the container
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        // Define a global variable to store the conversation log
        let conversationLog = [];

        // Function to append a message to the conversation log
        function appendToLog(message, sender) {
            conversationLog.push({ message, sender });
        }

        async function sendMessage() {
            const userMessage = userInput.value.trim();
            if (userMessage !== "") {
                appendMessage(userMessage, "user");
                // Append user message to the conversation log
                appendToLog(userMessage, "user");
                const response = await query({"in-0": userMessage, "user_id": ""}, "https://api.stack-ai.com/inference/v0/run/ac522f2a-ccb2-4608-8bab-3e1ccf74af42/663905242c2e38e8a381736b", "f39536ea-6cd4-4afe-ac99-bd9babd2cd21");
                console.log(response); // Log the entire response object
                const botMessage = response?.outputs?.['out-0'] || "Sorry, I couldn't understand that.";
                appendMessage(botMessage, "bot");
                // Append bot message to the conversation log
                appendToLog(botMessage, "bot");
                userInput.value = ""; // Clear the input field
            }
        }

        async function sendConversationLog() {
            const logMessages = conversationLog.map(entry => `${entry.sender === 'user' ? 'User' : 'Bot'}: ${entry.message}`).join('\n');
            const firstApiResponse = await query({
                "in-0": logMessages,
                "user_id": "<USER or Conversation ID>"
            }, "https://api.stack-ai.com/inference/v0/run/ac522f2a-ccb2-4608-8bab-3e1ccf74af42/663905242c2e38e8a381736b", "f39536ea-6cd4-4afe-ac99-bd9babd2cd21");
            console.log(firstApiResponse); // Log the response from the first API

            // Send the response from the first API to the second API
            const secondApiResponse = await query({
                "in-0": firstApiResponse.outputs['out-0'],
                "user_id": "<USER or Conversation ID>"
            }, "https://api.stack-ai.com/inference/v0/run/ac522f2a-ccb2-4608-8bab-3e1ccf74af42/663b8b5178d943c1cd118d55", "f39536ea-6cd4-4afe-ac99-bd9babd2cd21");
            console.log(secondApiResponse); // Log the response from the second API

            const responseString = JSON.stringify(secondApiResponse);
            // Redirect to the output page with the API response
            window.location.href = `output.html?response=${encodeURIComponent(responseString)}`;
        }

        // Focus on the input field when the page loads
        userInput.focus();

        // Handle Enter key press
        userInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });

        // Display welcome message from the bot on page load
        appendMessage("Welcome to Charlotte! My name is AI Bot and I am an assistant built to help you find your perfect neighborhood in Charlotte and answer any questions you may have. To get started let me know what you are looking for in a neighborhood?", "bot");
    </script>
</body>
</html>
